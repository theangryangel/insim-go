<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Map</title>
    <script type="module">
      import Vue from "https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.esm.browser.js";
      var app = new Vue({
        el: "#app",
        data: {
          state: {
            Players: [],
          },
          messages: [],
          max: 10,
          ws: null,
        },
        computed: {
          players: function () {
            return Object.values(this.state.Players).sort(function (a, b) {
              return a.RacePosition - b.RacePosition;
            });
          },
        },
        methods: {
          dial: function () {
            this.ws = new WebSocket(`ws://${document.location.host}/subscribe`);

            this.ws.addEventListener("close", (ev) => {
              console.log(
                `WebSocket Disconnected code: ${ev.code}, reason: ${ev.reason}`,
                true
              );
              if (ev.code !== 1001) {
                console.log("Reconnecting in 1s", true);
                setTimeout(this.dial, 1000);
              }
            });
            this.ws.addEventListener("open", (ev) => {
              console.info("websocket connected");
              this.initialState();
            });

            // This is where we handle messages received.
            this.ws.addEventListener("message", (ev) => {
              if (typeof ev.data !== "string") {
                console.error("unexpected message type", typeof ev.data);
                return;
              }
              console.log(ev);
              this.pushMsg(ev.data);
            });
          },
          pushMsg: function (msg) {
            this.messages.unshift(msg);
            while (this.messages.length >= this.max) {
              this.messages.pop();
            }
          },
          initialState: function () {
            fetch("/api/state")
              .then((res) => {
                return res.json();
              })
              .then((res) => {
                this.state = res;
              });
          },
        },
        created: function () {
          this.dial();
        },
      });
    </script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    <style type="text/css" media="screen">
      html,
      body {
        margin: 0;
        font-family: "Inter var";
        display: flex;

        height: 100vh;
        width: 100%;
      }

      * {
        box-sizing: border-box;
      }

      .players {
        flex: 0 1 auto;
        width: 25%;
        padding: 2em;
        background-color: #0a5e9d;
      }

      .map {
        flex: 1 1 auto;
        padding: 2em;
      }

      #app {
        display: flex;
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="players" id="players">
        <ul>
          <li v-for="(item, _index) in players">
            {{ item.Playername }} {{ item.RacePosition }} {{ item.RaceLap }} /
            {{ state.Laps }}
          </li>
        </ul>
      </div>
      <div class="map" id="map">
        <ul>
          <li v-for="(item, _index) in messages">{{ item }}</li>
        </ul>
      </div>
    </div>
  </body>
</html>
